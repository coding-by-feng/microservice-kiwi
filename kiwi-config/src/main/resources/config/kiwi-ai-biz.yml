security:
  oauth2:
    client:
      client-id: ENC(wORgugqWfXlIuzbal/3pjXTNXij/RSpo)
      client-secret: ENC(rMd1buB3iI+si+W99eB+QFa3QburIEmY)
      scope: server

# 数据源
spring:
  main:
    allow-bean-definition-overriding: true
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: ENC(2PE/BMMoNPbRCEaIyGfcSw==)
    password: ENC(zF1rDpn+u8RZX5OTor7BpHzprZyrH+3P)
    url: jdbc:mysql://${DB_IP}:3306/kiwi_db?allowPublicKeyRetrieval=true&useUnicode=true&characterEncoding=UTF-8&useSSL=false&autoReconnect=true&serverTimezone=Pacific/Auckland
    hikari:
      connection-test-query: SELECT 1
      maximum-pool-size: 30  # Increase but within MySQL's max_connections limit
      connection-timeout: 300000  # Fail faster when connections unavailable
      idle-timeout: 300000  # Release idle connections sooner (5 minutes)
      max-lifetime: 1200000  # Shorter connection lifetime (20 minutes)
      keepalive-time: 240000  # Keep connections alive with periodic pings
      leak-detection-threshold: 300000  # Detect connection leaks  task:
    execution:
      pool:
        core-size: 1
        max-size: 1
        queue-capacity: 100
      thread-name-prefix: YTB-subtitles-thread-

management:
  health:
    elasticsearch:
      enabled: false
  endpoints:
    web:
      exposure:
        include: '*'

ignore:
  urls:
    - /actuator/**

ms:
  config:
    exclude-db: false
    exclude-cache: false

ai:
  grok:
    api:
      key: ${GROK_API_KEY}  # Replace with the actual API key
      endpoint: https://api.x.ai/v1/chat/completions  # Hypothetical endpoint
      model: "grok-4-1-fast-reasoning"
      thread-prompts-line-size: 400
      thread-pool-size: 8
      thread-timeout-secs: 120
  mode:
    directly-translation: "Translate the user prompt into #[TL]. Output the translation only—no labels, notes, or Markdown."
    translation-and-explanation: "Translate the user prompt into #[TL] on the first line. Then, in #[NL], give a thorough explanation covering word choice, tone/register, key grammar, and cultural/usage notes. No Markdown or extra headers."
    grammar-explanation: "Translate the user prompt into #[NL]. Then, in #[NL], explain the grammar (parts of speech, sentence structure, tense/aspect, key patterns, and tricky points). Keep it concise and clear."
    grammar-correction: "1) Provide a grammatically corrected version of the text (original language). 2) Translate the corrected text into #[NL]. 3) In #[NL], explain each correction (what changed and why). Output in that order. No extra commentary."
    natural-idiomatic-retouch: "Rewrite the text in #[TL] so that it is grammatically correct, natural, and idiomatic, as if written by an educated native speaker. Preserve the original meaning and tone, but improve word choice, sentence flow, and style. Output only the polished #[TL] version, with #[NL] explanations."
    vocabulary-explanation: "Explain the vocabulary item in both #[TL] and #[NL]. Provide paraphrases in both languages grouped by part of speech (verb, noun, adjective, adverb, etc.). For each part of speech, give 1–3 demo sentences in #[TL] with #[NL] translations. Skip any part of speech that does not apply."
    synonym: "List 5–8 common synonyms in #[TL]. For each, briefly explain the nuance in #[NL] and give one example sentence in #[TL] with a #[NL] translation. Output plain text only—no Markdown or extra commentary."
    antonym: "List 5–8 common antonyms in #[TL]. For each, briefly explain the nuance in #[NL] and give one example sentence in #[TL] with a #[NL] translation. Output plain text only—no Markdown or extra commentary."
    subtitle-translator: "You need to calibrate the subtitle text, because the original subtitles may lack proper punctuation. You must identify each complete subtitle sentence and add accurate punctuation, ensuring each full sentence becomes one line. For each subtitle line, output two lines: Line 1 = the original line with corrected punctuation; Line 2 = #[NL] translation. Keep the same order and number of lines as the input. No extra text, no Markdown."
    subtitle-retouch: "Can you extract, clean, and calibrate the subtitle content without altering the original meaning? Remove only unused or redundant symbols while keeping the timeline and subtitle lines intact. The timeline should appear above each corresponding subtitle. Identify complete sentences within each subtitle line, correct punctuation and casing, and ensure each full sentence becomes one line. The language and number of subtitle lines must remain exactly the same as the input. Output one corrected subtitle line for each input line, with no extra text and no Markdown."
    subtitle-retouch-translator: "Reformat a sequence of subtitle lines. If a line is in #[TL], fix grammar and add natural punctuation, then output each complete sentence on its own line, and immediately under each such sentence output its translation into #[NL]. If a line is already in #[NL], only correct and output the #[NL] sentence without adding a #[TL] line or a second translation. Preserve the logical order of the input and return plain text only, with no Markdown, labels, or extra commentary."
    vocabulary-association: "List as many common #[TL] words/phrases as possible that can express the user prompt’s meaning. For each item, explain nuances, register, and usage differences in #[NL]. Group closely related items when helpful. Plain text only."
    phrases-association: "List as many common #[TL] phrases as possible that can express the user prompt’s meaning. For each phrase, explain nuances, register, and usage differences in #[NL]. Group by function or context when helpful. Plain text only."
    selection-explanation: "Respond only in #[TL]. Explain the selected phrase “#[S0]” strictly based on the sentence #[S1] in 1–2 concise paragraphs. No headings, labels, English, Markdown, bullet points, or backslashes. Do not restate the full sentence; focus on meaning, nuance, tense/aspect, and function in context."
    vocabulary-character-expansion: "vocabulary-family-expansion:
For the input word, generate a complete word-family #[TL] map including:
1) Verbs
2) Nouns
3) Adjectives
4) Adverbs

For each item, use the format:
word (#[NL] Chinese translation; #[NL] nuance or usage explanation)

Structure:
Verbs: v1 (#[NL] translation; #[NL] nuance), v2 (...), v3 (...)
Nouns: n1 (...), n2 (...)
Adjectives: a1 (...), a2 (...)
Adverbs: adv1 (...), adv2 (...)

Rules:
- Include only words that are truly related by root, morphology, or strong semantic relation
- Prioritize the most common 3–6 items in each group
- Nuance must be short, clear, and show how the word differs in use
- Output only English except for the Chinese translations
- Do not add any extra commentary outside the required structure"
    ambiguous-association-correction: "Correction:
Provide the corrected form of the input. If the input is misspelled, grammatically incorrect, or ambiguous, correct it or choose the most likely intended meaning. If no clear correction exists, set Correction to Unknown.

Alternatives:
List several closely related, commonly confused, or meaning-adjacent alternatives (alt1, alt2, alt3). All alternatives must be in #[TL].

Rules:
- Detect and correct misspellings, unclear expressions, or ambiguous phrases
- Always output both Correction and Alternatives
- Alternatives must be realistic confusion candidates, not random words
- If Correction is Unknown, still provide Alternatives
- Output in plain text only, no Markdown"

youtube:
  # Select implementation: api (YouTube Data API) or yt-dlp (local CLI)
  mode: yt-dlp # Change to yt-dlp to use local extraction without API quotas
  api:
    # Get your API key from Google Cloud Console
    # Enable YouTube Data API v3
    key: ${YTB_API_KEY}
    base-url: https://www.googleapis.com/youtube/v3
    max-results-per-page: 50
    region-code: US
    timeout-ms: 30000
    max-videos-per-channel: 1000
    enabled: true

  oauth:
    # Optional: For caption content download
    client-id: ${YTB_OAUTH_CLIENT_ID}
    client-secret: ${YTB_OAUTH_CLIENT_SECRET}
    client-secrets-file: ${YTB_OAUTH_CLIENT_SECRETS_FILE}
    access-token: ${YTB_OAUTH_ACCESS_TOKEN}
    redirect-uri: ${GOOGLE_OAUTH2_REDIRECT_URI}
    enabled: false

  video:
    # Path where yt-dlp will store temporary downloads (ensure writable)
    download:
      path: /tmp/ytb-downloads
    # yt-dlp executable command (must be in PATH or absolute path)
    command: yt-dlp
    # Ordered preferred subtitle languages (first match wins)
    subtitles:
      langs: en-US,en-GB,en
    large-subtitles:
      threshold: 100

rest-template:
  http-client:
    max-total-connections: 20  # Lower for tests to reduce resource usage
    max-connections-per-route: 10
    validate-after-inactivity: 500
    connection-time-to-live: 10
  request-factory:
    connect-timeout: 100000  # Faster timeouts for tests
    read-timeout: 100000
  retry:
    max-attempts: 3  # Fewer retries for faster tests
    retryable-exceptions:
      - "me.fengorz.kiwi.common.sdk.exception.ai.GrokAiException"
      # REST Client Exceptions (General)

      - "org.springframework.web.client.RestClientException"
      - "org.springframework.web.client.ResourceAccessException"

      # HTTP Server Errors (5xx) - Usually transient
      - "org.springframework.web.client.HttpServerErrorException"

      # Network/Connection Exceptions
      - "java.net.SocketTimeoutException"
      - "java.net.ConnectException"
      - "java.net.SocketException"
      - "java.net.UnknownHostException"
      - "java.io.IOException"
      - "javax.net.ssl.SSLException"
      - "javax.net.ssl.SSLHandshakeException"
      - "org.apache.http.conn.ConnectTimeoutException"
      - "org.apache.http.conn.HttpHostConnectException"
      - "org.apache.http.NoHttpResponseException"
    backoff-period: 500  # Faster backoff for tests

# Custom async executor configuration
async:
  executor:
    thread:
      core-pool-size: 1
      max-pool-size: 1
      queue-capacity: 100
      thread-name-prefix: YTB-subtitles-thread-
      rejected-execution-policy: CALLER_RUNS  # Options: ABORT, CALLER_RUNS, DISCARD, DISCARD_OLDEST