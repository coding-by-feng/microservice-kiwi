services:
  kiwi-gate:
    image: kiwi-gate:2.0
    user: root
    environment:
      - KIWI_ENC_PASSWORD=${KIWI_ENC_PASSWORD}
      - DB_IP=${DB_IP}
    volumes:
      - ~/docker/kiwi/gate/logs:/logs:Z
    network_mode: "host"
    healthcheck:
      test: ["CMD-SHELL", "code=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:9991/actuator/health); [ \"$$code\" = \"200\" ] || [ \"$$code\" = \"401\" ] || [ \"$$code\" = \"403\" ]"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 4m
    entrypoint:
      - java
      - -Xmx512m
      - -Duser.timezone=GMT+12
      - -Djava.awt.headless=true
      - -Dspring.profiles.active=prod
      - -Dlogging.file.name=/logs/gate.log
      - -jar
      - /app.jar

  kiwi-upms:
    image: kiwi-upms:2.0
    user: root
    environment:
      - KIWI_ENC_PASSWORD=${KIWI_ENC_PASSWORD}
      - DB_IP=${DB_IP}
    volumes:
      - ~/docker/kiwi/upms/logs:/logs:Z
    network_mode: "host"
    depends_on:
      kiwi-gate:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "code=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:4001/actuator/health); [ \"$$code\" = \"200\" ] || [ \"$$code\" = \"401\" ] || [ \"$$code\" = \"403\" ]"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 4m
    entrypoint:
      - java
      - -Xmx400m
      - -Duser.timezone=GMT+12
      - -Dspring.profiles.active=prod
      - -Dlogging.file.name=/logs/upms-biz.log
      - -jar
      - /app.jar

  kiwi-auth:
    image: kiwi-auth:2.0
    user: root
    environment:
      - KIWI_ENC_PASSWORD=${KIWI_ENC_PASSWORD}
      - DB_IP=${DB_IP}
      - GOOGLE_OAUTH2_CLIENT_ID=${GOOGLE_OAUTH2_CLIENT_ID}
      - GOOGLE_OAUTH2_CLIENT_SECRET=${GOOGLE_OAUTH2_CLIENT_SECRET}
      - GOOGLE_OAUTH2_REDIRECT_URI=${GOOGLE_OAUTH2_REDIRECT_URI}
      - HOME_PAGE=${HOME_PAGE}
    volumes:
      - ~/docker/kiwi/auth/logs:/logs:Z
    network_mode: "host"
    depends_on:
      kiwi-upms:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "code=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:3001/actuator/health); [ \"$$code\" = \"200\" ] || [ \"$$code\" = \"401\" ] || [ \"$$code\" = \"403\" ]"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 4m
    entrypoint:
      - java
      - -Xmx256m
      - -Duser.timezone=GMT+12
      - -Dspring.profiles.active=prod
      - -Dlogging.file.name=/logs/auth.log
      - -jar
      - /app.jar

  kiwi-word-biz:
    image: kiwi-word-biz:2.0
    user: root
    environment:
      - KIWI_ENC_PASSWORD=${KIWI_ENC_PASSWORD}
      - DB_IP=${DB_IP}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}
    volumes:
      - ~/docker/kiwi/word/logs:/logs:Z
      - ~/docker/kiwi/word/bizTmp:/wordTmp:Z
    network_mode: "host"
    depends_on:
      kiwi-auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "kiwi-word-biz"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 4m
    entrypoint:
      - java
      - -Xmx1024m
      - -Duser.timezone=GMT+12
      - -Dspring.application.name=kiwi-word-biz
      - -Dspring.profiles.active=prod
      - -Dcom.sun.management.autodiscovery=true
      - -Dlogging.file.name=/logs/word-biz.log
      - -jar
      - /app.jar

  kiwi-ai-biz:
    image: kiwi-ai-biz:2.0
    user: root
    environment:
      - KIWI_ENC_PASSWORD=${KIWI_ENC_PASSWORD}
      - DB_IP=${DB_IP}
      - GROK_API_KEY=${GROK_API_KEY}
      - YTB_API_KEY=${YTB_API_KEY}
    volumes:
      - ~/docker/kiwi/ai/logs:/logs:Z
      - ~/docker/kiwi/ai/tmp:/ai-tmp:Z
    network_mode: "host"
    depends_on:
      kiwi-word-biz:
        condition: service_healthy
      kiwi-auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "kiwi-ai-biz"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 4m
    entrypoint:
      - java
      - -Xms512m
      - -Xmx1048m
      - -XX:+UseG1GC
      - -XX:MaxGCPauseMillis=200
      - -Duser.timezone=GMT+12
      - -jar
      - /app/app.jar

  kiwi-tools-biz:
    image: kiwi-tools-biz:2.0
    user: root
    environment:
      - KIWI_ENC_PASSWORD=${KIWI_ENC_PASSWORD}
      - DB_IP=${DB_IP}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}
    volumes:
      - ~/docker/kiwi/tools/logs:/logs:Z
    network_mode: "host"
    depends_on:
      kiwi-ai-biz:
        condition: service_healthy
      kiwi-auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "kiwi-tools-biz"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 4m
    entrypoint:
      - java
      - -Xmx700m
      - -Duser.timezone=GMT+12
      - -Dspring.profiles.active=prod
      - -Dlogging.file.name=/logs/tools-biz.log
      - -jar
      - /app.jar

  kiwi-crawler:
    image: kiwi-crawler:2.0
    user: root
    environment:
      - KIWI_ENC_PASSWORD=${KIWI_ENC_PASSWORD}
      - DB_IP=${DB_IP}
    volumes:
      - ~/docker/kiwi/crawler/logs:/logs:Z
      - ~/docker/kiwi/crawler/tmp:/crawlerTmp:Z
    network_mode: "host"
    depends_on:
      kiwi-ai-biz:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "code=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:6001/actuator/health); [ \"$$code\" = \"200\" ] || [ \"$$code\" = \"401\" ] || [ \"$$code\" = \"403\" ]"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 4m
    entrypoint:
      - java
      - -Xmx1000m
      - -Duser.timezone=GMT+12
      - -Xmn300m
      - -Dspring.profiles.active=prod
      - -Dlogging.file.name=/logs/crawler.log
      - -jar
      - /app.jar
